@page "/export"
@inject JournalApp.Services.PdfExportService Exporter
@inject JournalApp.Services.JournalService Journal

<div class="page-header">
    <div>
        <h1 class="h-title">ðŸ“„ Export</h1>
        <p class="h-sub">Export your journal entries for backup or sharing (HTML file, no extra libraries).</p>
    </div>
</div>

<div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <div>
            <div style="font-weight:1000; font-size:1.05rem;">Export Range</div>
            <div class="helper">Choose dates, then export.</div>
        </div>
        <span class="badge info">HTML</span>
    </div>

    <div class="grid cols-3 section">
        <div class="field">
            <div class="label">From</div>
            <input class="input" type="date" @bind="_from" @bind:format="yyyy-MM-dd" />
        </div>

        <div class="field">
            <div class="label">To</div>
            <input class="input" type="date" @bind="_to" @bind:format="yyyy-MM-dd" />
        </div>

        <div class="field">
            <div class="label">File name</div>
            <input class="input" @bind="_fileName" placeholder="Journal_Export" />
            <div class="helper">.html will be added automatically</div>
        </div>
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn primary" @onclick="ExportNow" disabled="@_busy">
            @if (_busy) { <span>Exporting...</span> } else { <span>Export</span> }
        </button>
        <button class="btn" @onclick="Reset" disabled="@_busy">Reset</button>
    </div>

    @if (!string.IsNullOrWhiteSpace(_msg))
    {
        <div class="card soft section" style="padding:.9rem;">
            <b style="color:@_msgColor">@_msg</b>
            @if (!string.IsNullOrWhiteSpace(_path))
            {
                <div class="helper" style="margin-top:6px;">Saved at: <b>@_path</b></div>
            }
        </div>
    }
</div>

@code {
    private DateTime _from = DateTime.Today.AddDays(-30);
    private DateTime _to = DateTime.Today;
    private string _fileName = "Journal_Export";

    private bool _busy = false;
    private string _msg = "";
    private string _msgColor = "var(--muted)";
    private string _path = "";

    private async Task ExportNow()
    {
        _msg = "";
        _path = "";
        _msgColor = "var(--muted)";
        _busy = true;

        try
        {
            if (_to < _from)
            {
                _msg = "Invalid range: 'To' date must be after 'From' date.";
                _msgColor = "var(--warning)";
                return;
            }

            var safeName = string.IsNullOrWhiteSpace(_fileName) ? "Journal_Export" : _fileName.Trim();
            safeName = string.Concat(safeName.Split(Path.GetInvalidFileNameChars()));
            if (!safeName.EndsWith(".html", StringComparison.OrdinalIgnoreCase))
                safeName += ".html";

            var entries = await Journal.FilterAsync(_from, _to, "", "", "");

            _path = await Exporter.ExportPdfAsync(entries, _from, _to, safeName);

            _msg = $"Export complete âœ… ({entries.Count} entries)";
            _msgColor = "var(--success)";
        }
        catch (Exception ex)
        {
            _msg = "Export failed: " + ex.Message;
            _msgColor = "var(--danger)";
        }
        finally
        {
            _busy = false;
        }
    }

    private void Reset()
    {
        _from = DateTime.Today.AddDays(-30);
        _to = DateTime.Today;
        _fileName = "Journal_Export";
        _msg = "";
        _path = "";
        _msgColor = "var(--muted)";
    }
}