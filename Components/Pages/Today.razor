@page "/today"
@inject JournalApp.Services.JournalService Journal
@inject JournalApp.Services.AuthService Auth
@inject NavigationManager Nav

<div class="page-header">
    <div>
        <h1 class="h-title">üìù Today</h1>
        <p class="h-sub">Write your journal entry for today.</p>
    </div>
    <span class="badge info">@_today.ToString("yyyy-MM-dd")</span>
</div>

<div class="grid cols-2" style="align-items:start;">
    <!-- Editor -->
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
            <div>
                <div style="font-weight:1000; font-size:1.05rem;">Entry</div>
                <div class="helper">One entry per day. Edit anytime.</div>
            </div>

            <span class="badge @(_loaded ? "success" : "warn")">
                @(_loaded ? "Loaded" : "New")
            </span>
        </div>

        <div class="section">
            <div class="field">
                <div class="label">Title</div>
                <input class="input" @bind="_title" placeholder="How was your day?" />
            </div>

            <div class="field">
                <div class="label">Write</div>
                <textarea class="input" rows="10" @bind="_content"
                          placeholder="Write your thoughts here..."></textarea>
                <div class="helper">Tip: Keep it real. No pressure.</div>
            </div>

            @if (!string.IsNullOrWhiteSpace(_msg))
            {
                <div class="card soft" style="padding:.85rem;">
                    <b style="color:@_msgColor">@_msg</b>
                </div>
            }

            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
                <button class="btn primary" @onclick="Save" disabled="@_saving">
                    @(_saving ? "Saving..." : "Save Entry")
                </button>
                <button class="btn" @onclick="Clear" disabled="@_saving">Clear</button>
                <button class="btn" @onclick="GoHistory" disabled="@_saving">Open History</button>

                <span class="helper" style="margin-left:auto;">
                    Words: <b>@_wordCount</b>
                </span>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <div style="font-weight:1000; font-size:1.05rem;">Mood & Tags</div>
                <div class="helper">Helps analytics + filtering later.</div>
            </div>
            <span class="badge info">@(_moodCategory)</span>
        </div>

        <div class="section">
            <div class="field">
                <div class="label">Mood</div>
                <select class="input" @bind="_mood">
                    <option value="">Select mood</option>
                    <option>Happy</option>
                    <option>Calm</option>
                    <option>Motivated</option>
                    <option>Neutral</option>
                    <option>Tired</option>
                    <option>Stressed</option>
                    <option>Sad</option>
                    <option>Angry</option>
                </select>
            </div>

            <div class="field">
                <div class="label">Mood Category</div>
                <select class="input" @bind="_moodCategory">
                    <option>Positive</option>
                    <option>Neutral</option>
                    <option>Negative</option>
                </select>
            </div>

            <div class="field">
                <div class="label">Tags (comma separated)</div>
                <input class="input" @bind="_tags" placeholder="study, work, friends" />
            </div>

            <div class="card soft" style="padding:.85rem; margin-top:10px;">
                <div style="font-weight:900;">Quick prompts</div>
                <ul class="helper" style="margin:8px 0 0 18px;">
                    <li>What was the best moment today?</li>
                    <li>What stressed you out?</li>
                    <li>One thing you learned?</li>
                </ul>
            </div>
        </div>
    </div>
</div>

@code {
    private readonly DateTime _today = DateTime.Today;

    private bool _loaded = false;
    private bool _saving = false;

    private string _title = "";
    private string _content = "";
    private string _mood = "";
    private string _moodCategory = "Positive";
    private string _tags = "";

    private string _msg = "";
    private string _msgColor = "var(--muted)";
    private int _wordCount = 0;

    protected override async Task OnInitializedAsync()
    {
        if (!Auth.IsLoggedIn)
        {
            Nav.NavigateTo("/login", true);
            return;
        }
        await Load();
        Recount();
    }

    private async Task Load()
    {
        _msg = "";
        var existing = await Journal.GetByDateAsync(_today);

        if (existing != null)
        {
            _loaded = true;
            _title = existing.Title ?? "";
            _content = HtmlToPlain(existing.ContentHtml ?? "");
            _mood = existing.PrimaryMood ?? "";
            _moodCategory = string.IsNullOrWhiteSpace(existing.PrimaryMoodCategory) ? "Positive" : existing.PrimaryMoodCategory!;
            _tags = existing.TagsCsv ?? "";
        }
        else
        {
            _loaded = false;
        }
    }

    private async Task Save()
    {
        _saving = true;
        _msg = "";
        _msgColor = "var(--muted)";

        try
        {
            if (string.IsNullOrWhiteSpace(_title)) _title = "Untitled";

            await Journal.UpsertAsync(
                date: _today,
                title: _title,
                content: _content,
                mood: _mood,
                moodCategory: _moodCategory,
                tagsCsv: _tags
            );

            _loaded = true;
            _msg = "Saved ‚úÖ";
            _msgColor = "var(--success)";
        }
        catch (Exception ex)
        {
            _msg = "Save failed: " + ex.Message;
            _msgColor = "var(--danger)";
        }
        finally
        {
            _saving = false;
            Recount();
        }
    }

    private void Clear()
    {
        _title = "";
        _content = "";
        _mood = "";
        _moodCategory = "Positive";
        _tags = "";
        _msg = "Cleared (not saved).";
        _msgColor = "var(--warning)";
        Recount();
    }

    private void GoHistory() => Nav.NavigateTo("/history", true);

    private void Recount()
    {
        _wordCount = CountWords(_content);
    }

    private static int CountWords(string text)
    {
        if (string.IsNullOrWhiteSpace(text)) return 0;
        var parts = text.Split(new[] { ' ', '\n', '\r', '\t' }, StringSplitOptions.RemoveEmptyEntries);
        return parts.Length;
    }

    // Converts stored HTML (with <br/>) back into plain text for textarea
    private static string HtmlToPlain(string html)
    {
        if (string.IsNullOrWhiteSpace(html)) return "";

        var s = html.Replace("<br/>", "\n").Replace("<br>", "\n").Replace("<br />", "\n");

        // strip remaining tags
        s = System.Text.RegularExpressions.Regex.Replace(s, "<.*?>", " ");

        // decode entities
        s = System.Net.WebUtility.HtmlDecode(s);

        return s.Trim();
    }
}