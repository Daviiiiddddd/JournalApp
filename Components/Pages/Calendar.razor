@page "/calendar"
@inject NavigationManager Nav

<h3>üóìÔ∏è Calendar</h3>
<p class="muted">Pick a day to open or edit that entry.</p>

<div class="card">
    <div class="calendar-header">
        <div>
            <div class="calendar-month">@_currentMonth.ToString("MMMM yyyy")</div>
            <div class="muted" style="font-size:0.9rem;">Tap any day to open the editor</div>
        </div>

        <div class="calendar-actions">
            <button class="btn secondary" @onclick="JumpToday">Today</button>
            <button class="btn secondary" @onclick="PrevMonth">‚óÄ</button>
            <button class="btn secondary" @onclick="NextMonth">‚ñ∂</button>
        </div>
    </div>

    <div class="calendar-grid">
        @foreach (var d in _weekDays)
        {
            <div class="weekday">@d</div>
        }

        @foreach (var cell in _cells)
        {
            if (cell == null)
            {
                <div class="day-empty"></div>
            }
            else
            {
                var date = cell.Value;
                var isToday = date.Date == DateTime.Today;

                <div class="day-tile @(isToday ? "day-today" : "")"
                     title="@date.ToString("yyyy-MM-dd")"
                     @onclick="() => OpenDate(date)">
                    @date.Day
                </div>
            }
        }
    </div>
</div>

@code {
    private readonly string[] _weekDays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
    private DateTime _currentMonth = new(DateTime.Today.Year, DateTime.Today.Month, 1);
    private List<DateTime?> _cells = new();

    protected override void OnInitialized()
    {
        BuildMonth();
    }

    private void BuildMonth()
    {
        _cells.Clear();

        var first = new DateTime(_currentMonth.Year, _currentMonth.Month, 1);
        int startOffset = (int)first.DayOfWeek;

        for (int i = 0; i < startOffset; i++)
            _cells.Add(null);

        int days = DateTime.DaysInMonth(_currentMonth.Year, _currentMonth.Month);
        for (int day = 1; day <= days; day++)
            _cells.Add(new DateTime(_currentMonth.Year, _currentMonth.Month, day));
    }

    private void PrevMonth()
    {
        _currentMonth = _currentMonth.AddMonths(-1);
        BuildMonth();
    }

    private void NextMonth()
    {
        _currentMonth = _currentMonth.AddMonths(1);
        BuildMonth();
    }

    private void JumpToday()
    {
        _currentMonth = new(DateTime.Today.Year, DateTime.Today.Month, 1);
        BuildMonth();
    }

    private void OpenDate(DateTime date)
    {
        Nav.NavigateTo($"/today?date={date:yyyy-MM-dd}");
    }
}